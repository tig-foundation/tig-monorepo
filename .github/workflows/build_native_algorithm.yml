name: Build tig-native algorithm

on:
  workflow_dispatch:
    inputs:
      challenge_type:
        description: 'Challenge type to build'
        required: true
        type: choice
        options:
          - knapsack
          - satisfiability
          - vector-search
          - vehicle-routing
      algorithm_name:
        description: 'Algorithm name'
        required: true
        type: string
      rust_toolchain:
        description: 'Rust toolchain to use'
        required: true
        type: choice
        options:
          - nightly-2024-12-17
          - nightly-2025-01-16
        default: nightly-2025-01-16
      llvm_release:
        description: 'LLVM release version'
        required: true
        type: choice
        options:
          - '0 - Testing 0.0.0'
          - '1 - Testing 0.0.1'
        default: '1 - Testing 0.0.1'

jobs:
  build:
    runs-on: ubuntu-22.04-arm
    container:
      image: debian:12
    permissions:
      contents: write
      statuses: write
    steps:
      - name: Install git
        run: |
          apt-get update -y
          apt-get install git -y
          
      - uses: actions/checkout@v4

      - name: Build tig-native
        env:
          ALGORITHM_NAME: ${{ inputs.algorithm_name }}
          LLVM_RELEASE: ${{ inputs.llvm_release }}
          RUST_TOOLCHAIN: ${{ inputs.rust_toolchain }}
        run: |
          LLVM_INDEX=$(echo "$LLVM_RELEASE" | cut -d' ' -f1)
          chmod +x tig-native/build.sh
          cd tig-native
          LLVM_RELEASE=${LLVM_INDEX} ./build.sh --${{ inputs.challenge_type }} .
          cd ..
          git config --global --add safe.directory "$(realpath .)"

      - name: Copy to algorithms directory
        run: |
          CHALLENGE_DIR=$(echo "${{ inputs.challenge_type }}" | tr '-' '_')
          mkdir -p tig-algorithms/native/${CHALLENGE_DIR}
          rm -f tig-algorithms/native/${CHALLENGE_DIR}/${{ inputs.algorithm_name }}.native
          cp tig-native/rtsig_blob.dylib tig-algorithms/native/${CHALLENGE_DIR}/${{ inputs.algorithm_name }}.native

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.challenge_type }}-${{ inputs.algorithm_name }}-${{ github.sha }}-${{ inputs.rust_toolchain }}
          path: tig-native/rtsig_blob.dylib

      - name: Auto commit
        id: auto_commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Compiled native algorithm ${{ inputs.algorithm_name }} for ${{ inputs.challenge_type }}
  
      - name: Update Commit Status (Success)
        if: success()
        uses: myrotvorets/set-commit-status-action@master
        with:
          status: 'success'
          sha: ${{ steps.auto_commit.outputs.commit_hash }}

      - name: Update Commit Status (Failure)
        if: failure()
        uses: myrotvorets/set-commit-status-action@master
        with:
          status: 'failure'
